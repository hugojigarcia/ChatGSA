<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat GSA</title>
    <link rel="icon" type="favicon/x-icon" href="static/favicon.png"/>
    <link rel="stylesheet" href="static/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> <!-- Font Awesome for icons -->
</head>
<body>
    <div id="title">
        <h1>Chat GSA</h1>
    </div>
    <div id="chat-container">
        <div id="chat-messages"></div>
        <div id="input-container">
            <textarea type="text" id="question" placeholder="Escribe tu pregunta aquÃ­..." oninput="autoResize()" autocomplete="off"></textarea>
            <button id="send-question" onclick="askQuestion()">
                <svg xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 404 511.5"><path fill-rule="nonzero" d="m219.24 72.97.54 438.53h-34.95l-.55-442.88L25.77 241.96 0 218.39 199.73 0 404 222.89l-25.77 23.58z"/></svg>
            </button>
        </div>
    </div>

    <script>
        var textarea_original_height = window.getComputedStyle(document.getElementById('question')).height;
        var textarea_max_height = parseInt(window.getComputedStyle(document.getElementById('chat-messages')).height) * 0.8;
        var chat_history = [];
        
        function askQuestion() {
            var question = document.getElementById('question').value;
            var question_to_show = question.replace(/\n/g, "<br>");
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/ask", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    var answer = response.answer;
                    var sources = response.sources;
                    chat_history = response.chat_history;

                    var responseHtml = "<div class='message user-message'><p>" + question_to_show + "</p></div>";
                    responseHtml += "<div class='message bot-message'><p>Respuesta: " + answer + "</p>";
                    if (sources.length > 0) {
                        responseHtml += "<p>Fuentes:</p>";
                        sources.forEach(function(source) {
                            responseHtml += "<div class='source'>";
                            responseHtml += "<p class='source-source'>Fuente: " + source.source + "</p>";
                            responseHtml += "<p class='source-text'>Texto: " + source.text + "</p>";

                            
                            responseHtml += "</div>";
                        });
                    }
                    responseHtml += "</div>";

                    document.getElementById("chat-messages").innerHTML += responseHtml;
                    document.getElementById('question').value = ''; // Clear input field
                    autoResize(); // Auto resize input field after clearing
                    scrollToBottom();
                }
            };
            xhr.send("question=" + question + "&chat_history=" + JSON.stringify(chat_history));
        }

        function more_than_one_line(textarea) {
            var lineHeight = parseInt(window.getComputedStyle(textarea).lineHeight);
            var lines_per_height = textarea.scrollHeight / lineHeight - 1;
            
            var lines_per_newline_characters = textarea.value.split('\n').length;
            return lines_per_height > 1 || lines_per_newline_characters > 1;
        }

        function check_max_height(textarea) {
            var height_textarea = parseInt(window.getComputedStyle(textarea).height);
            return height_textarea > textarea_max_height;
        }

        function autoResize() {
            var textarea = document.getElementById('question');
            if (textarea.value === '') {
                textarea.style.height = textarea_original_height;
            } else if (more_than_one_line(textarea)) {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
                if (check_max_height(textarea)) {
                    textarea.style.height = textarea_max_height + 'px';
                    textarea.style.overflowY = 'scroll';
                }
            }
        }

        function scrollToBottom() {
            var chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    autoResize();
                } else {
                    event.preventDefault();
                    askQuestion();
                }
            }

        }
        const inputField = document.getElementById('question');
        inputField.addEventListener('keypress', handleKeyPress);
    </script>
</body>
</html>
